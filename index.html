<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {getDatabase,ref,onValue,push,update} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const app=initializeApp({
 apiKey:"AIzaSyChBGm2SO7uuW9gIhpFH-MDFzWs0gp9eps",
 databaseURL:"https://database-7209-default-rtdb.firebaseio.com"
});
const db=getDatabase(app);

let qty=0,price=0,orderId="";
const upi="bharatpe@upi";

/* LIVE PRICE */
onValue(ref(db,"settings/pricePerId"),s=>{
 price=s.val()||0;
});

/* QTY */
window.setQty=(q,e)=>{
 qty=q;
 document.querySelectorAll(".box").forEach(b=>b.classList.remove("active"));
 e.classList.add("active");
 enable();
};

window.customQty=()=>{
 qty=+custom.value;
 enable();
};

function enable(){
 if(qty>0){
  buy.classList.add("active");
  buy.innerText=`Buy â‚¹${qty*price}`;
 }
}

/* CREATE ORDER */
window.pay=()=>{
 if(qty<=0) return alert("Qty select karo");

 orderId=push(ref(db,"orders"),{
  qty,
  amount:qty*price,
  status:"pending",
  time:Date.now()
 }).key;

 select.style.display="none";
 payment.style.display="block";
 pq.innerText=qty;
 pa.innerText=qty*price;

 qr.src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data="
 +encodeURIComponent(`upi://pay?pa=${upi}&am=${qty*price}&cu=INR`);
};

/* SUBMIT UTR */
window.submit=()=>{
 if(!utr.value) return alert("UTR enter karo");

 update(ref(db,"orders/"+orderId),{
  utr:utr.value,
  status:"paid"
 });

 alert("Payment submitted. Admin verify karega.");

 /* REALTIME VERIFY LISTENER */
 onValue(ref(db,"orders/"+orderId+"/status"),s=>{
  if(s.val()==="verified"){
   loadIDs();
  }
 });
};

/* LOAD IDS */
function loadIDs(){
 onValue(ref(db,"deliveries/"+orderId),snap=>{
  let out="";
  snap.forEach(c=>{
   const v=c.val();
   out+=`${v.username} | ${v.password} | ${v.phone} | ${v.email}\n`;
  });
  ids.innerText=out;
  payment.style.display="none";
  success.style.display="block";
 },{onlyOnce:true});
}

window.copy=()=>{
 navigator.clipboard.writeText(ids.innerText);
 alert("IDs Copied");
};
</script>
