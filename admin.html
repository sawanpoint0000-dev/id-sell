<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
body{font-family:Arial;background:#eef2f5;padding:20px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px}
input,button{padding:10px;margin-top:8px;width:100%}
button{background:#4f46e5;color:#fff;border:none;border-radius:6px}
.order{border:1px solid #ddd;padding:10px;margin-top:10px}
.stock{font-size:13px;color:#333}
</style>
</head>
<body>

<div class="card">
<h3>Update Price</h3>
<input id="price" placeholder="Price per ID">
<button onclick="setPrice()">Save</button>
</div>

<div class="card">
<h3>Add ID Stock</h3>
<input id="u" placeholder="Username">
<input id="p" placeholder="Password">
<input id="ph" placeholder="Phone">
<input id="e" placeholder="Email">
<button onclick="addID()">Add ID</button>
<div id="stockCount" class="stock"></div>
</div>

<div class="card">
<h3>Pending Orders</h3>
<div id="orders"></div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {getDatabase,ref,onValue,push,update,remove,get} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const app=initializeApp({
 apiKey:"AIzaSyChBGm2SO7uuW9gIhpFH-MDFzWs0gp9eps",
 databaseURL:"https://database-7209-default-rtdb.firebaseio.com"
});
const db=getDatabase(app);

window.setPrice=()=>update(ref(db,"settings"),{pricePerId:+price.value});

window.addID=()=>{
 if(!u.value||!p.value||!ph.value||!e.value) return alert("All fields required");
 push(ref(db,"stock"),{
  username:u.value.trim(),
  password:p.value.trim(),
  phone:ph.value.trim(),
  email:e.value.trim(),
  sold:false
 });
 u.value=p.value=ph.value=e.value="";
 alert("ID Added");
};

onValue(ref(db,"stock"),s=>{
 let c=0;
 s.forEach(()=>c++);
 stockCount.innerText="Stock: "+c;
});

onValue(ref(db,"orders"),snap=>{
 orders.innerHTML="";
 snap.forEach(o=>{
  let v=o.val();
  if(v.status==="pending" && v.utr){
   orders.innerHTML+=`
   <div class="order">
   Qty: ${v.qty}<br>
   UTR: ${v.utr}
   <button onclick="verify('${o.key}',${v.qty})">Verify & Deliver</button>
   </div>`;
  }
 });
});

window.verify=async(orderId,qty)=>{
 const stockSnap=await get(ref(db,"stock"));
 let delivered={},count=0;

 stockSnap.forEach(s=>{
  if(count<qty){
   delivered[s.key]=s.val();
   remove(ref(db,"stock/"+s.key));
   count++;
  }
 });

 if(count<qty) return alert("Not enough stock!");

 await update(ref(db,"deliveries/"+orderId),delivered);
 await update(ref(db,"orders/"+orderId),{status:"verified"});
 alert("Delivered Successfully");
};
</script>
</body>
</html>
