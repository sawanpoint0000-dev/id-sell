<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<style>
*{box-sizing:border-box;font-family:system-ui}
body{
 margin:0;
 min-height:100vh;
 background:linear-gradient(180deg,#4f46e5,#6d6af5);
 padding:18px;
}
.container{max-width:440px;margin:auto}
.card{
 background:#fff;
 border-radius:22px;
 padding:20px;
 margin-bottom:18px;
 box-shadow:0 15px 35px rgba(0,0,0,.25);
}
h2{text-align:center;color:#4f46e5;margin:0 0 14px}
input,textarea,button{
 width:100%;
 padding:14px;
 margin-top:12px;
 border-radius:16px;
 border:1.5px solid #ddd;
 font-size:15px;
}
button{
 border:none;
 font-weight:800;
 color:#fff;
 background:#4f46e5;
 cursor:pointer;
}
.logout{background:#ef4444}
.order{
 background:#f8fafc;
 border-radius:16px;
 padding:14px;
 margin-top:12px;
 font-size:14px;
}
.order b{display:block;margin-bottom:4px}
.verify{background:#22c55e;margin-top:8px}
</style>
</head>

<body>
<div class="container">

<div class="card" id="loginCard">
<h2>üîê Admin Login</h2>
<input id="email" placeholder="Admin Email">
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>

<div class="card" id="panel" style="display:none">
<h2>‚öôÔ∏è Admin Panel</h2>

<input id="price" type="number" placeholder="Price per ID">
<button onclick="savePrice()">Update Price</button>

<hr>

<textarea id="ids" rows="6" placeholder="username
password
phone
email"></textarea>
<button onclick="addIDs()">Add IDs</button>

<h3>üì¶ Available Stock: <span id="stock">0</span></h3>

<h3>‚è≥ Pending Orders</h3>
<div id="orders"></div>

<button class="logout" onclick="logout()">Logout</button>

<audio id="alertAudio">
 <source src="beep.mp3" type="audio/mpeg">
</audio>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, update, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const app = initializeApp({
 apiKey:"AIzaSyChBGm2SO7uuW9gIhpFH-MDFzWs0gp9eps",
 databaseURL:"https://database-7209-default-rtdb.firebaseio.com"
});

const auth = getAuth(app);
const db   = getDatabase(app);

/* LOGIN */
window.login=()=>{
 signInWithEmailAndPassword(auth,email.value,pass.value)
 .then(()=>{
  loginCard.style.display="none";
  panel.style.display="block";
 })
 .catch(e=>alert(e.message));
};

/* LOGOUT */
window.logout=()=>signOut(auth).then(()=>{
 panel.style.display="none";
 loginCard.style.display="block";
});

/* PRICE */
window.savePrice=()=>set(ref(db,"settings/pricePerId"),Number(price.value));

/* ADD IDS */
window.addIDs=()=>{
 const l=ids.value.trim().split("\n");
 if(l.length%4!==0) return alert("4 lines per ID");
 for(let i=0;i<l.length;i+=4){
  push(ref(db,"stock"),{
   username:l[i],
   password:l[i+1],
   phone:l[i+2],
   email:l[i+3],
   sold:false
  });
 }
 ids.value="";
};

/* STOCK COUNT */
onValue(ref(db,"stock"),s=>{
 let c=0;
 s.forEach(x=>{ if(!x.val().sold) c++; });
 stock.innerText=c;
});

/* ORDERS */
onValue(ref(db,"orders"),snap=>{
 orders.innerHTML="";
 snap.forEach(o=>{
  const v=o.val();
  if(v.status==="pending"){
   const d=document.createElement("div");
   d.className="order";
   d.innerHTML=`
    <b>Order:</b> ${o.key}
    <b>Qty:</b> ${v.qty}
    <b>Amount:</b> ‚Çπ${v.amount}
    <button class="verify" onclick="verify('${o.key}',${v.qty})">Verify</button>
   `;
   orders.appendChild(d);

   document.getElementById("alertAudio").play().catch(()=>{});
   navigator.vibrate?.(300);
  }
 });
});

/* VERIFY (FIXED) */
window.verify=async(orderId,qty)=>{
 const snap=await get(ref(db,"stock"));
 let free=[];
 snap.forEach(s=>{
  if(!s.val().sold && free.length<qty){
   free.push({id:s.key,...s.val()});
  }
 });

 if(free.length<qty) return alert("Not enough stock");

 for(const id of free){
  await update(ref(db,"stock/"+id.id),{sold:true});
  await push(ref(db,"deliveries/"+orderId),{
   username:id.username,
   password:id.password,
   phone:id.phone,
   email:id.email
  });
 }

 await update(ref(db,"orders/"+orderId),{status:"verified"});
 alert("Delivered successfully ‚úÖ");
};
</script>
</body>
</html>
