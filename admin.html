<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {getDatabase,ref,onValue,push,update,remove} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const app=initializeApp({
 apiKey:"AIzaSyChBGm2SO7uuW9gIhpFH-MDFzWs0gp9eps",
 databaseURL:"https://database-7209-default-rtdb.firebaseio.com"
});
const db=getDatabase(app);

/* PRICE */
window.setPrice=()=>update(ref(db,"settings"),{
 pricePerId:+price.value
});

/* ADD ID */
window.addID=()=>{
 push(ref(db,"stock"),{
  username:u.value,
  password:p.value,
  phone:ph.value,
  email:e.value,
  time:Date.now()
 });
 alert("ID Added");
};

/* SHOW ONLY PAID ORDERS */
onValue(ref(db,"orders"),snap=>{
 orders.innerHTML="";
 snap.forEach(o=>{
  const v=o.val();
  if(v.status==="paid"){
   orders.innerHTML+=`
   <div class="order">
     <b>Qty:</b> ${v.qty}<br>
     <b>UTR:</b> ${v.utr}<br>
     <button onclick="verify('${o.key}',${v.qty})">
       Verify & Deliver
     </button>
   </div>`;
  }
 });
});

/* VERIFY */
window.verify=async(orderId,qty)=>{
 const stockSnap = await new Promise(r=>
   onValue(ref(db,"stock"),s=>r(s),{onlyOnce:true})
 );

 let delivered={},count=0;

 stockSnap.forEach(s=>{
  if(count<qty){
   delivered[s.key]=s.val();
   remove(ref(db,"stock/"+s.key));
   count++;
  }
 });

 if(count<qty){
  alert("Not enough stock");
  return;
 }

 update(ref(db,"deliveries/"+orderId),delivered);
 update(ref(db,"orders/"+orderId),{status:"verified"});

 alert("IDs Delivered Successfully");
};
</script>
