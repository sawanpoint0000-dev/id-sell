<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<style>
*{box-sizing:border-box;font-family:system-ui}
body{
 margin:0;
 min-height:100vh;
 background:linear-gradient(180deg,#4f46e5,#6d6af5);
 padding:18px;
}
.container{max-width:440px;margin:auto}
.card{
 background:#fff;
 border-radius:22px;
 padding:20px;
 margin-bottom:18px;
 box-shadow:0 15px 35px rgba(0,0,0,.25);
}
h2{text-align:center;color:#4f46e5;margin:0 0 14px}
input,textarea,button{
 width:100%;
 padding:14px;
 margin-top:12px;
 border-radius:16px;
 border:1.5px solid #ddd;
 font-size:15px;
}
button{
 border:none;
 font-weight:800;
 color:#fff;
 background:#4f46e5;
 cursor:pointer;
}
.logout{background:#ef4444}
.order{
 background:#f8fafc;
 border-radius:16px;
 padding:14px;
 margin-top:12px;
 font-size:14px;
}
.order b{display:block;margin-bottom:4px}
.verify{background:#22c55e;margin-top:8px}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div class="card" id="loginCard">
<h2>üîê Admin Login</h2>
<input id="email" placeholder="Admin Email">
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>

<!-- PANEL -->
<div class="card" id="panel" style="display:none">
<h2>‚öôÔ∏è Admin Panel</h2>

<input id="price" type="number" placeholder="Price per ID">
<button onclick="savePrice()">Update Price</button>

<hr style="margin:16px 0">

<textarea id="ids" rows="6" placeholder="Add IDs (4 lines per ID)
username
password
phone
email"></textarea>
<button onclick="addIDs()">Add IDs to Stock</button>

<hr style="margin:16px 0">

<h3>üì¶ Available Stock: <span id="stock">0</span></h3>

<hr style="margin:16px 0">

<h3>‚è≥ Pending Orders</h3>
<div id="orders"></div>

<button class="logout" onclick="logout()">Logout</button>

<!-- üîî SOUND FILE (same folder me beep.mp3) -->
<audio id="alertAudio" src="beep.mp3" loop></audio>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const app = initializeApp({
 apiKey:"AIzaSyChBGm2SO7uuW9gIhpFH-MDFzWs0gp9eps",
 databaseURL:"https://database-7209-default-rtdb.firebaseio.com"
});

const auth = getAuth(app);
const db   = getDatabase(app);

/* üîî SOUND FLAGS */
let audioAllowed = false;
let isBeeping = false;

/* LOGIN */
window.login=()=> {
 signInWithEmailAndPassword(auth,email.value.trim(),pass.value)
 .then(()=>{
  loginCard.style.display="none";
  panel.style.display="block";

  // üîî SOUND permission unlock
  const audio = document.getElementById("alertAudio");
  audio.volume = 1;
  audio.play().then(()=>{
    audio.pause();
    audio.currentTime = 0;
    audioAllowed = true;
  }).catch(()=>{});
 })
 .catch(e=>alert(e.message));
};

/* LOGOUT */
window.logout=()=> {
 signOut(auth).then(()=>{
  panel.style.display="none";
  loginCard.style.display="block";
 });
};

/* PRICE */
window.savePrice=()=> {
 set(ref(db,"settings/pricePerId"),Number(price.value));
};

/* ADD STOCK */
window.addIDs=()=> {
 const lines=ids.value.trim().split("\n");
 if(lines.length%4!==0) return;
 for(let i=0;i<lines.length;i+=4){
  push(ref(db,"stock"),{
   username:lines[i],
   password:lines[i+1],
   phone:lines[i+2],
   email:lines[i+3],
   sold:false
  });
 }
 ids.value="";
};

/* STOCK COUNT */
onValue(ref(db,"stock"),snap=>{
 let c=0;
 snap.forEach(s=>{ if(!s.val().sold) c++; });
 stock.innerText=c;
});

/* üî• PENDING ORDERS ‚Üí CONTINUOUS BEEP */
onValue(ref(db,"orders"),snap=>{
 orders.innerHTML="";
 let pendingCount = 0;

 snap.forEach(o=>{
  const v=o.val();
  if(v.status==="pending"){
   pendingCount++;

   const d=document.createElement("div");
   d.className="order";
   d.innerHTML=`
    <b>Order ID:</b> ${o.key}
    <b>Qty:</b> ${v.qty}
    <b>Amount:</b> ‚Çπ${v.amount}
    <b>UTR:</b> ${v.utr || "N/A"}
    <button class="verify" onclick="verify('${o.key}',${v.qty})">
      Verify & Deliver
    </button>
   `;
   orders.appendChild(d);
  }
 });

 const audio = document.getElementById("alertAudio");

 // üîî START BEEP
 if(pendingCount > 0 && audioAllowed && !isBeeping){
  audio.currentTime = 0;
  audio.play().catch(()=>{});
  isBeeping = true;

  if(navigator.vibrate){
    navigator.vibrate([600,300,600,300]);
  }
 }

 // üîï STOP BEEP
 if(pendingCount === 0 && isBeeping){
  audio.pause();
  audio.currentTime = 0;
  isBeeping = false;
 }
});

/* VERIFY + DELIVER */
window.verify=(orderId,qty)=>{
 onValue(ref(db,"stock"),snap=>{
  let taken=[];
  snap.forEach(s=>{
   if(!s.val().sold && taken.length<qty){
    taken.push({id:s.key,...s.val()});
   }
  });

  if(taken.length<qty) return;

  taken.forEach(id=>{
   update(ref(db,"stock/"+id.id),{sold:true});
   push(ref(db,"deliveries/"+orderId),{
    username:id.username,
    password:id.password,
    phone:id.phone,
    email:id.email
   });
  });

  update(ref(db,"orders/"+orderId),{status:"verified"});
 });
};
</script>
</body>
</html>
