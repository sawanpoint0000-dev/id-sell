<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
body{font-family:Arial;background:#eef2f5;padding:20px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px}
input,button{padding:10px;margin-top:8px;width:100%}
button{background:#4f46e5;color:#fff;border:none;border-radius:6px}
.order{border:1px solid #ddd;padding:10px;margin-top:10px}
</style>
</head>

<body>

<div class="card">
<h3>Price Update</h3>
<input id="price" placeholder="Price per ID">
<button onclick="setPrice()">Update</button>
</div>

<div class="card">
<h3>Add ID Stock</h3>
<input id="u" placeholder="Username">
<input id="p" placeholder="Password">
<input id="ph" placeholder="Phone">
<input id="e" placeholder="Email">
<button onclick="addID()">Add ID</button>
</div>

<div class="card">
<h3>Pending Orders</h3>
<div id="orders"></div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {getDatabase,ref,onValue,push,update,remove} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const app=initializeApp({
 apiKey:"AIzaSyChBGm2SO7uuW9gIhpFH-MDFzWs0gp9eps",
 databaseURL:"https://database-7209-default-rtdb.firebaseio.com"
});
const db=getDatabase(app);

window.setPrice=()=>update(ref(db,"settings"),{pricePerId:+price.value});

window.addID=()=>{
 push(ref(db,"stock"),{
  username:u.value,password:p.value,phone:ph.value,email:e.value
 });
 alert("ID Added");
}

onValue(ref(db,"orders"),snap=>{
 orders.innerHTML="";
 snap.forEach(o=>{
  let v=o.val();
  if(v.status=="pending"){
   orders.innerHTML+=`
   <div class="order">
   Qty: ${v.qty}<br>UTR: ${v.utr||"-"}
   <button onclick="verify('${o.key}',${v.qty})">Verify</button>
   </div>`;
  }
 });
});

window.verify=async(id,qty)=>{
 const stockSnap=await new Promise(r=>onValue(ref(db,"stock"),s=>r(s),{onlyOnce:true}));
 let delivered={}; let c=0;

 stockSnap.forEach(s=>{
  if(c<qty){
   delivered[s.key]=s.val();
   remove(ref(db,"stock/"+s.key));
   c++;
  }
 });

 update(ref(db,"deliveries/"+id),delivered);
 update(ref(db,"orders/"+id),{status:"verified"});
 alert("Delivered");
}
</script>
</body>
</html>
